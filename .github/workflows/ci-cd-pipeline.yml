name: Shared CI/CD Pipeline

on:
  workflow_call:
    inputs:
      app_name:
        description: 'Application service name (used in systemctl, inventory paths, etc.)'
        required: true
        type: string
      app_port:
        description: 'Port for health checks'
        required: false
        default: '7868'
        type: string
      python_version:
        description: 'Python version to use'
        required: false
        default: '3.12'
        type: string
      environment_hostnames:
        description: 'Custom hostnames in format: dev=hostname1,test=hostname2,prod=hostname3'
        required: false
        default: 'dev=dev01,test=test01,prod=prod01'
        type: string
      health_check_path:
        description: 'HTTP path for health check (e.g., /health or /api/health)'
        required: false
        default: '/health'
        type: string
      slack_webhook_url:
        description: 'Slack webhook URL for deployment notifications'
        required: false
        default: ''
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ðŸ” 1. Linting
  lint:
    name: Lint Python Code
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}

      - name: Install linting tools
        run: pip install flake8

      - name: Run linting
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

  # ðŸ§ª 2. Unit Tests (run before dev deployment only)
  test:
    name: Run Unit Tests
    runs-on: [self-hosted, test]
    needs: lint
    # Only run unit tests before development deployment
    if: |
      github.ref == 'refs/heads/dev' ||
      startsWith(github.ref, 'refs/heads/feature/') ||
      startsWith(github.ref, 'refs/heads/feat/') ||
      startsWith(github.ref, 'refs/heads/bug/') ||
      startsWith(github.ref, 'refs/heads/fix/') ||
      startsWith(github.ref, 'refs/heads/hotfix/') ||
      startsWith(github.ref, 'refs/heads/refactor/') ||
      startsWith(github.ref, 'refs/heads/claude/')
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}

      - name: Install dependencies
        run: |
          python -m venv venv
          source venv/bin/activate
          pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
          pip install pytest pytest-cov

      - name: Run tests
        env:
          TEST_DB: '1'
        run: |
          source venv/bin/activate
          pytest tests --maxfail=5 --disable-warnings -v

  # ðŸš€ 3. Deployment (environment-specific jobs)
  deploy_dev:
    name: Deploy to Development
    runs-on: [self-hosted, dev]
    environment: development
    needs: test
    if: |
      github.ref == 'refs/heads/dev' ||
      startsWith(github.ref, 'refs/heads/feature/') ||
      startsWith(github.ref, 'refs/heads/feat/') ||
      startsWith(github.ref, 'refs/heads/bug/') ||
      startsWith(github.ref, 'refs/heads/fix/') ||
      startsWith(github.ref, 'refs/heads/hotfix/') ||
      startsWith(github.ref, 'refs/heads/refactor/') ||
      startsWith(github.ref, 'refs/heads/claude/')
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}

      - name: Parse environment hostnames
        id: hostnames
        run: |
          HOSTNAMES="${{ inputs.environment_hostnames }}"
          ENV="development"

          # Map environment names to short prefixes
          case "$ENV" in
            development) PREFIX="dev" ;;
            test) PREFIX="test" ;;
            production) PREFIX="prod" ;;
            *) echo "Unknown environment: $ENV"; exit 1 ;;
          esac

          # Extract hostname for this environment
          HOST=$(echo "$HOSTNAMES" | tr ',' '\n' | grep "^${PREFIX}=" | cut -d'=' -f2)

          # Set default if not found
          if [ -z "$HOST" ]; then
            case "$ENV" in
              development) HOST="dev01" ;;
              test) HOST="test01" ;;
              production) HOST="prod01" ;;
            esac
          fi

          echo "hostname=${HOST}" >> $GITHUB_OUTPUT

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible

      - name: Deploy with Ansible
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          if [ ! -d "ansible" ]; then
            echo "Error: ansible directory not found"
            exit 1
          fi
          cd ansible
          ansible-playbook -i inventory/development/hosts.yml \
            playbooks/deploy.yml \
            -e "openai_api_key=${OPENAI_API_KEY}" \
            -e "app_name=${{ inputs.app_name }}" \
            -e "app_port=${{ inputs.app_port }}"

      - name: Verify Deployment
        run: |
          HOST="${{ steps.hostnames.outputs.hostname }}"
          echo "Checking service status on $HOST..."
          ansible $HOST -i ansible/inventory/development/hosts.yml \
            -m shell -a "systemctl status ${{ inputs.app_name }} --no-pager" -b

          echo "Checking recent logs..."
          ansible $HOST -i ansible/inventory/development/hosts.yml \
            -m shell -a "journalctl -u ${{ inputs.app_name }} -n 20 --no-pager" -b

      - name: Health Check
        run: |
          HOST="${{ steps.hostnames.outputs.hostname }}"
          echo "Waiting for service to start..."
          sleep 10

          # Check if service is active
          ansible $HOST -i ansible/inventory/development/hosts.yml \
            -m shell -a "systemctl is-active ${{ inputs.app_name }}" -b

          # HTTP health check
          echo "Performing HTTP health check on port ${{ inputs.app_port }}..."
          ansible $HOST -i ansible/inventory/development/hosts.yml \
            -m shell -a "curl -f http://localhost:${{ inputs.app_port }}${{ inputs.health_check_path }} || exit 1" -b

      - name: Send notification
        if: always() && inputs.slack_webhook_url != ''
        env:
          SLACK_WEBHOOK_URL: ${{ inputs.slack_webhook_url }}
          JOB_STATUS: ${{ job.status }}
        run: |
          STATUS="${JOB_STATUS:-unknown}"
          COLOR="good"
          if [ "$STATUS" != "success" ]; then
            COLOR="danger"
          fi

          # Capitalize environment name for display
          ENV_DISPLAY="development"
          ENV_DISPLAY="$(echo ${ENV_DISPLAY:0:1} | tr '[:lower:]' '[:upper:]')${ENV_DISPLAY:1}"

          # Add rocket emoji for production
          TITLE="${ENV_DISPLAY} Deployment"
          if [ "development" = "production" ]; then
            TITLE="ðŸš€ ${TITLE}"
          fi

          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d "{
              \"attachments\": [{
                \"color\": \"$COLOR\",
                \"title\": \"$TITLE\",
                \"text\": \"${{ inputs.app_name }} deployment to development: $STATUS\",
                \"fields\": [
                  {\"title\": \"Repository\", \"value\": \"${{ github.repository }}\", \"short\": true},
                  {\"title\": \"Branch\", \"value\": \"${{ github.ref_name }}\", \"short\": true},
                  {\"title\": \"Commit\", \"value\": \"${{ github.sha }}\", \"short\": true},
                  {\"title\": \"Actor\", \"value\": \"${{ github.actor }}\", \"short\": true}
                ]
              }]
            }"

      - name: Deployment summary
        if: success()
        run: |
          echo "âœ… ${{ inputs.app_name }} successfully deployed to development!"
          echo "Environment: development"
          echo "Host: ${{ steps.hostnames.outputs.hostname }}"
          echo "Port: ${{ inputs.app_port }}"

  deploy_test:
    name: Deploy to Test
    runs-on: [self-hosted, test]
    environment: test
    needs: lint
    if: github.ref == 'refs/heads/test'
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}

      - name: Parse environment hostnames
        id: hostnames
        run: |
          HOSTNAMES="${{ inputs.environment_hostnames }}"
          ENV="test"

          # Map environment names to short prefixes
          case "$ENV" in
            development) PREFIX="dev" ;;
            test) PREFIX="test" ;;
            production) PREFIX="prod" ;;
            *) echo "Unknown environment: $ENV"; exit 1 ;;
          esac

          # Extract hostname for this environment
          HOST=$(echo "$HOSTNAMES" | tr ',' '\n' | grep "^${PREFIX}=" | cut -d'=' -f2)

          # Set default if not found
          if [ -z "$HOST" ]; then
            case "$ENV" in
              development) HOST="dev01" ;;
              test) HOST="test01" ;;
              production) HOST="prod01" ;;
            esac
          fi

          echo "hostname=${HOST}" >> $GITHUB_OUTPUT

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible

      - name: Deploy with Ansible
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          if [ ! -d "ansible" ]; then
            echo "Error: ansible directory not found"
            exit 1
          fi
          cd ansible
          ansible-playbook -i inventory/test/hosts.yml \
            playbooks/deploy.yml \
            -e "openai_api_key=${OPENAI_API_KEY}" \
            -e "app_name=${{ inputs.app_name }}" \
            -e "app_port=${{ inputs.app_port }}"

      - name: Verify Deployment
        run: |
          HOST="${{ steps.hostnames.outputs.hostname }}"
          echo "Checking service status on $HOST..."
          ansible $HOST -i ansible/inventory/test/hosts.yml \
            -m shell -a "systemctl status ${{ inputs.app_name }} --no-pager" -b

          echo "Checking recent logs..."
          ansible $HOST -i ansible/inventory/test/hosts.yml \
            -m shell -a "journalctl -u ${{ inputs.app_name }} -n 20 --no-pager" -b

      - name: Health Check
        run: |
          HOST="${{ steps.hostnames.outputs.hostname }}"
          echo "Waiting for service to start..."
          sleep 10

          # Check if service is active
          ansible $HOST -i ansible/inventory/test/hosts.yml \
            -m shell -a "systemctl is-active ${{ inputs.app_name }}" -b

          # HTTP health check
          echo "Performing HTTP health check on port ${{ inputs.app_port }}..."
          ansible $HOST -i ansible/inventory/test/hosts.yml \
            -m shell -a "curl -f http://localhost:${{ inputs.app_port }}${{ inputs.health_check_path }} || exit 1" -b

      - name: Send notification
        if: always() && inputs.slack_webhook_url != ''
        env:
          SLACK_WEBHOOK_URL: ${{ inputs.slack_webhook_url }}
          JOB_STATUS: ${{ job.status }}
        run: |
          STATUS="${JOB_STATUS:-unknown}"
          COLOR="good"
          if [ "$STATUS" != "success" ]; then
            COLOR="danger"
          fi

          # Capitalize environment name for display
          ENV_DISPLAY="test"
          ENV_DISPLAY="$(echo ${ENV_DISPLAY:0:1} | tr '[:lower:]' '[:upper:]')${ENV_DISPLAY:1}"

          # Add rocket emoji for production
          TITLE="${ENV_DISPLAY} Deployment"
          if [ "test" = "production" ]; then
            TITLE="ðŸš€ ${TITLE}"
          fi

          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d "{
              \"attachments\": [{
                \"color\": \"$COLOR\",
                \"title\": \"$TITLE\",
                \"text\": \"${{ inputs.app_name }} deployment to test: $STATUS\",
                \"fields\": [
                  {\"title\": \"Repository\", \"value\": \"${{ github.repository }}\", \"short\": true},
                  {\"title\": \"Branch\", \"value\": \"${{ github.ref_name }}\", \"short\": true},
                  {\"title\": \"Commit\", \"value\": \"${{ github.sha }}\", \"short\": true},
                  {\"title\": \"Actor\", \"value\": \"${{ github.actor }}\", \"short\": true}
                ]
              }]
            }"

      - name: Deployment summary
        if: success()
        run: |
          echo "âœ… ${{ inputs.app_name }} successfully deployed to test!"
          echo "Environment: test"
          echo "Host: ${{ steps.hostnames.outputs.hostname }}"
          echo "Port: ${{ inputs.app_port }}"

  deploy_prod:
    name: Deploy to Production
    runs-on: [self-hosted, prod]
    environment: production
    needs: lint
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}

      - name: Parse environment hostnames
        id: hostnames
        run: |
          HOSTNAMES="${{ inputs.environment_hostnames }}"
          ENV="production"

          # Map environment names to short prefixes
          case "$ENV" in
            development) PREFIX="dev" ;;
            test) PREFIX="test" ;;
            production) PREFIX="prod" ;;
            *) echo "Unknown environment: $ENV"; exit 1 ;;
          esac

          # Extract hostname for this environment
          HOST=$(echo "$HOSTNAMES" | tr ',' '\n' | grep "^${PREFIX}=" | cut -d'=' -f2)

          # Set default if not found
          if [ -z "$HOST" ]; then
            case "$ENV" in
              development) HOST="dev01" ;;
              test) HOST="test01" ;;
              production) HOST="prod01" ;;
            esac
          fi

          echo "hostname=${HOST}" >> $GITHUB_OUTPUT

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible

      - name: Deploy with Ansible
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          if [ ! -d "ansible" ]; then
            echo "Error: ansible directory not found"
            exit 1
          fi
          cd ansible
          ansible-playbook -i inventory/production/hosts.yml \
            playbooks/deploy.yml \
            -e "openai_api_key=${OPENAI_API_KEY}" \
            -e "app_name=${{ inputs.app_name }}" \
            -e "app_port=${{ inputs.app_port }}"

      - name: Verify Deployment
        run: |
          HOST="${{ steps.hostnames.outputs.hostname }}"
          echo "Checking service status on $HOST..."
          ansible $HOST -i ansible/inventory/production/hosts.yml \
            -m shell -a "systemctl status ${{ inputs.app_name }} --no-pager" -b

          echo "Checking recent logs..."
          ansible $HOST -i ansible/inventory/production/hosts.yml \
            -m shell -a "journalctl -u ${{ inputs.app_name }} -n 20 --no-pager" -b

      - name: Health Check
        run: |
          HOST="${{ steps.hostnames.outputs.hostname }}"
          echo "Waiting for service to start..."
          sleep 10

          # Check if service is active
          ansible $HOST -i ansible/inventory/production/hosts.yml \
            -m shell -a "systemctl is-active ${{ inputs.app_name }}" -b

          # HTTP health check
          echo "Performing HTTP health check on port ${{ inputs.app_port }}..."
          ansible $HOST -i ansible/inventory/production/hosts.yml \
            -m shell -a "curl -f http://localhost:${{ inputs.app_port }}${{ inputs.health_check_path }} || exit 1" -b

      - name: Send notification
        if: always() && inputs.slack_webhook_url != ''
        env:
          SLACK_WEBHOOK_URL: ${{ inputs.slack_webhook_url }}
          JOB_STATUS: ${{ job.status }}
        run: |
          STATUS="${JOB_STATUS:-unknown}"
          COLOR="good"
          if [ "$STATUS" != "success" ]; then
            COLOR="danger"
          fi

          # Capitalize environment name for display
          ENV_DISPLAY="production"
          ENV_DISPLAY="$(echo ${ENV_DISPLAY:0:1} | tr '[:lower:]' '[:upper:]')${ENV_DISPLAY:1}"

          # Add rocket emoji for production
          TITLE="${ENV_DISPLAY} Deployment"
          if [ "production" = "production" ]; then
            TITLE="ðŸš€ ${TITLE}"
          fi

          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d "{
              \"attachments\": [{
                \"color\": \"$COLOR\",
                \"title\": \"$TITLE\",
                \"text\": \"${{ inputs.app_name }} deployment to production: $STATUS\",
                \"fields\": [
                  {\"title\": \"Repository\", \"value\": \"${{ github.repository }}\", \"short\": true},
                  {\"title\": \"Branch\", \"value\": \"${{ github.ref_name }}\", \"short\": true},
                  {\"title\": \"Commit\", \"value\": \"${{ github.sha }}\", \"short\": true},
                  {\"title\": \"Actor\", \"value\": \"${{ github.actor }}\", \"short\": true}
                ]
              }]
            }"

      - name: Deployment summary
        if: success()
        run: |
          echo "âœ… ${{ inputs.app_name }} successfully deployed to production!"
          echo "Environment: production"
          echo "Host: ${{ steps.hostnames.outputs.hostname }}"
          echo "Port: ${{ inputs.app_port }}"
