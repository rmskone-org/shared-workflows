name: Shared CI/CD Pipeline

on:
  workflow_call:
    inputs:
      app_name:
        description: 'Application service name (used in systemctl, inventory paths, etc.)'
        required: true
        type: string
      app_port:
        description: 'Port for health checks'
        required: false
        default: '7868'
        type: string
      python_version:
        description: 'Python version to use'
        required: false
        default: '3.12'
        type: string
      environment_hostnames:
        description: 'Custom hostnames in format: dev=hostname1,test=hostname2,prod=hostname3'
        required: false
        default: 'dev=dev01,test=test01,prod=prod01'
        type: string
      health_check_path:
        description: 'HTTP path for health check (e.g., /health or /api/health)'
        required: false
        default: '/health'
        type: string
      slack_webhook_url:
        description: 'Slack webhook URL for deployment notifications'
        required: false
        default: ''
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # üîç 1. Linting
  lint:
    name: Lint Python Code
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}

      - name: Install linting tools
        run: pip install flake8

      - name: Run linting
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

  # üß™ 2. Unit Tests
  test:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}

      - name: Install dependencies
        run: |
          python -m venv venv
          source venv/bin/activate
          pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
          pip install pytest pytest-cov

      - name: Run tests
        env:
          TEST_DB: '1'
        run: |
          source venv/bin/activate
          pytest tests --maxfail=5 --disable-warnings -v

  # üöÄ 3. Deployment (environment-specific jobs)
  deploy_dev:
    name: Deploy to Development
    runs-on: [self-hosted, dev]
    environment: development
    needs: test
    if: |
      github.ref == 'refs/heads/dev' ||
      startsWith(github.ref, 'refs/heads/feature/') ||
      startsWith(github.ref, 'refs/heads/feat/') ||
      startsWith(github.ref, 'refs/heads/bug/') ||
      startsWith(github.ref, 'refs/heads/fix/') ||
      startsWith(github.ref, 'refs/heads/hotfix/') ||
      startsWith(github.ref, 'refs/heads/refactor/')
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}

      - name: Deploy Application
        uses: ./.github/actions/deploy
        with:
          environment: development
          app_name: ${{ inputs.app_name }}
          app_port: ${{ inputs.app_port }}
          python_version: ${{ inputs.python_version }}
          environment_hostnames: ${{ inputs.environment_hostnames }}
          health_check_path: ${{ inputs.health_check_path }}
          slack_webhook_url: ${{ inputs.slack_webhook_url }}
          openai_api_key: ${{ secrets.OPENAI_API_KEY }}

  deploy_test:
    name: Deploy to Test
    runs-on: [self-hosted, test]
    environment: test
    needs: test
    if: github.ref == 'refs/heads/test'
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}

      - name: Deploy Application
        uses: ./.github/actions/deploy
        with:
          environment: test
          app_name: ${{ inputs.app_name }}
          app_port: ${{ inputs.app_port }}
          python_version: ${{ inputs.python_version }}
          environment_hostnames: ${{ inputs.environment_hostnames }}
          health_check_path: ${{ inputs.health_check_path }}
          slack_webhook_url: ${{ inputs.slack_webhook_url }}
          openai_api_key: ${{ secrets.OPENAI_API_KEY }}

  deploy_prod:
    name: Deploy to Production
    runs-on: [self-hosted, prod]
    needs: test
    if: github.ref == 'refs/heads/main'
    environment: production
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}

      - name: Deploy Application
        uses: ./.github/actions/deploy
        with:
          environment: production
          app_name: ${{ inputs.app_name }}
          app_port: ${{ inputs.app_port }}
          python_version: ${{ inputs.python_version }}
          environment_hostnames: ${{ inputs.environment_hostnames }}
          health_check_path: ${{ inputs.health_check_path }}
          slack_webhook_url: ${{ inputs.slack_webhook_url }}
          openai_api_key: ${{ secrets.OPENAI_API_KEY }}
