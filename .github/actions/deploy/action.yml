name: 'Deploy Application'
description: 'Deploys application using Ansible with verification and health checks'
inputs:
  environment:
    description: 'Environment to deploy to (development, test, production)'
    required: true
  app_name:
    description: 'Application service name'
    required: true
  app_port:
    description: 'Port for health checks'
    required: true
  python_version:
    description: 'Python version to use'
    required: true
  environment_hostnames:
    description: 'Custom hostnames in format: dev=hostname1,test=hostname2,prod=hostname3'
    required: true
  health_check_path:
    description: 'HTTP path for health check'
    required: true
  slack_webhook_url:
    description: 'Slack webhook URL for deployment notifications'
    required: false
    default: ''
  openai_api_key:
    description: 'OpenAI API key for deployment'
    required: false
    default: ''

runs:
  using: 'composite'
  steps:
    - name: Parse environment hostnames
      id: hostnames
      shell: bash
      run: |
        HOSTNAMES="${{ inputs.environment_hostnames }}"
        ENV="${{ inputs.environment }}"

        # Map environment names to short prefixes
        case "$ENV" in
          development) PREFIX="dev" ;;
          test) PREFIX="test" ;;
          production) PREFIX="prod" ;;
          *) echo "Unknown environment: $ENV"; exit 1 ;;
        esac

        # Extract hostname for this environment
        HOST=$(echo "$HOSTNAMES" | tr ',' '\n' | grep "^${PREFIX}=" | cut -d'=' -f2)

        # Set default if not found
        if [ -z "$HOST" ]; then
          case "$ENV" in
            development) HOST="dev01" ;;
            test) HOST="test01" ;;
            production) HOST="prod01" ;;
          esac
        fi

        echo "hostname=${HOST}" >> $GITHUB_OUTPUT

    - name: Install Ansible
      shell: bash
      run: |
        python -m pip install --upgrade pip
        pip install ansible

    - name: Deploy with Ansible
      shell: bash
      env:
        OPENAI_API_KEY: ${{ inputs.openai_api_key }}
      run: |
        if [ ! -d "ansible" ]; then
          echo "Error: ansible directory not found"
          exit 1
        fi
        cd ansible
        ansible-playbook -i inventory/${{ inputs.environment }}/hosts.yml \
          playbooks/deploy.yml \
          -e "openai_api_key=${OPENAI_API_KEY}" \
          -e "app_name=${{ inputs.app_name }}" \
          -e "app_port=${{ inputs.app_port }}"

    - name: Verify Deployment
      shell: bash
      run: |
        HOST="${{ steps.hostnames.outputs.hostname }}"
        echo "Checking service status on $HOST..."
        ansible $HOST -i ansible/inventory/${{ inputs.environment }}/hosts.yml \
          -m shell -a "systemctl status ${{ inputs.app_name }} --no-pager" -b

        echo "Checking recent logs..."
        ansible $HOST -i ansible/inventory/${{ inputs.environment }}/hosts.yml \
          -m shell -a "journalctl -u ${{ inputs.app_name }} -n 20 --no-pager" -b

    - name: Health Check
      shell: bash
      run: |
        HOST="${{ steps.hostnames.outputs.hostname }}"
        echo "Waiting for service to start..."
        sleep 10

        # Check if service is active
        ansible $HOST -i ansible/inventory/${{ inputs.environment }}/hosts.yml \
          -m shell -a "systemctl is-active ${{ inputs.app_name }}" -b

        # HTTP health check
        echo "Performing HTTP health check on port ${{ inputs.app_port }}..."
        ansible $HOST -i ansible/inventory/${{ inputs.environment }}/hosts.yml \
          -m shell -a "curl -f http://localhost:${{ inputs.app_port }}${{ inputs.health_check_path }} || exit 1" -b

    - name: Send notification
      if: always() && inputs.slack_webhook_url != ''
      shell: bash
      env:
        SLACK_WEBHOOK_URL: ${{ inputs.slack_webhook_url }}
        JOB_STATUS: ${{ job.status }}
      run: |
        STATUS="${JOB_STATUS:-unknown}"
        COLOR="good"
        if [ "$STATUS" != "success" ]; then
          COLOR="danger"
        fi

        # Capitalize environment name for display
        ENV_DISPLAY="${{ inputs.environment }}"
        ENV_DISPLAY="$(echo ${ENV_DISPLAY:0:1} | tr '[:lower:]' '[:upper:]')${ENV_DISPLAY:1}"

        # Add rocket emoji for production
        TITLE="${ENV_DISPLAY} Deployment"
        if [ "${{ inputs.environment }}" = "production" ]; then
          TITLE="ðŸš€ ${TITLE}"
        fi

        curl -X POST "$SLACK_WEBHOOK_URL" \
          -H 'Content-Type: application/json' \
          -d "{
            \"attachments\": [{
              \"color\": \"$COLOR\",
              \"title\": \"$TITLE\",
              \"text\": \"${{ inputs.app_name }} deployment to ${{ inputs.environment }}: $STATUS\",
              \"fields\": [
                {\"title\": \"Repository\", \"value\": \"${{ github.repository }}\", \"short\": true},
                {\"title\": \"Branch\", \"value\": \"${{ github.ref_name }}\", \"short\": true},
                {\"title\": \"Commit\", \"value\": \"${{ github.sha }}\", \"short\": true},
                {\"title\": \"Actor\", \"value\": \"${{ github.actor }}\", \"short\": true}
              ]
            }]
          }"

    - name: Deployment summary
      if: success()
      shell: bash
      run: |
        echo "âœ… ${{ inputs.app_name }} successfully deployed to ${{ inputs.environment }}!"
        echo "Environment: ${{ inputs.environment }}"
        echo "Host: ${{ steps.hostnames.outputs.hostname }}"
        echo "Port: ${{ inputs.app_port }}"
